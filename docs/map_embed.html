<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Interactive Map</title>
  <link id="leaflet-css" rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <style>
    html,body{height:100%;margin:0;padding:0}
    #map{height:100vh}
    .leaflet-popup-content{max-width:560px !important}
    .popupimg{max-width:520px;width:100%;display:block;margin-top:6px;border-radius:6px}
    #err{position:fixed;right:8px;bottom:8px;background:#fee;border:1px solid #f99;border-radius:6px;padding:6px 10px;color:#900;font:13px system-ui}
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="err" style="display:none"></div>

  <script>
  // Simple error helper
  function showErr(msg){try{var e=document.getElementById("err");e.textContent=msg;e.style.display="block";}catch(_){}}

  // Load Leaflet from CDN, then fall back to local if it fails
  (function loadLeaflet(){
    var s=document.createElement("script");
    s.src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js";
    s.onload=init;
    s.onerror=function(){
      showErr("CDN failed. Using local Leaflet…");
      var lc=document.getElementById("leaflet-css");
      if(lc) lc.href="assets/leaflet/leaflet.css";
      var ls=document.createElement("script");
      ls.src="assets/leaflet/leaflet.js";
      ls.onload=init;
      ls.onerror=function(){showErr("Could not load Leaflet (CDN/local).");};
      document.body.appendChild(ls);
    };
    document.body.appendChild(s);
  })();

  function init(){
    if(!(window.L)){showErr("Leaflet not available.");return;}
    var map=L.map("map").setView([38.9,-75.2],8);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:"© OpenStreetMap"}).addTo(map);

    fetch("assets/geo/latest_run.geojson")
      .then(function(r){if(!r.ok)throw new Error("latest_run.geojson not found");return r.json();})
      .then(function(g){
        L.geoJSON(g,{onEachFeature:function(f,l){
          var p=f.properties||{};
          var html="<strong>"+(p.name||"Transect")+"</strong>";
          if(p.image){
            var im=String(p.image);
            html+=`<br><a href="${im}" target="_blank" rel="noopener"><img class="popupimg" src="${im}"></a>`+
                   `<div style="margin-top:4px"><a href="${im}" target="_blank" rel="noopener">Open full size</a></div>`;
          }
          l.bindPopup(html,{maxWidth:560});
        }}).addTo(map);
      })
      .catch(function(e){showErr("GeoJSON error: "+e.message);
        var m=L.marker([39.1582,-75.5244]).addTo(map);
        m.bindPopup("Could not load GeoJSON: "+e.message);
      });
  }
  </script>
</body>
</html>
